from random import randrange
from enum import Enum

from .entities.monster import MonsterFactory
from .entities.player import Player


class Result(Enum):
    CONTINUE = 0
    WIN = 1
    LOSE = 2


class ActionResult:
    def __init__(self, result: Result, message: str):
        self.result = result
        self.message = message


class Encounter:
    # Constructor
    def __init__(self, player: Player):
        self.player = player
        self.mob = MonsterFactory().get_random_monster(player.get_level())

    # Methods
    def do_player_attack(self):
        damage = self.player.do_attack()
        return self.mob.take_damage(damage), damage

    def do_mob_attack(self):
        damage = self.mob.do_attack()
        return self.player.take_damage(damage), damage

    def battle(self):
        mob_alive, player_damage = self.do_player_attack()
        if mob_alive:
            player_alive, mob_damage = self.do_mob_attack()
            if not player_alive:
                return ActionResult(
                    Result.LOSE,
                    f"You died! You dealt {player_damage} damage to the {self.mob.get_name()}, but the {self.mob.get_name()} dealt {mob_damage} damage to you.",
                )
            else:
                return ActionResult(
                    Result.CONTINUE,
                    f"You dealt {player_damage} damage to the {self.mob.get_name()}, but the {self.mob.get_name()} dealt {mob_damage} damage to you.",
                )
        else:
            self.player.add_xp(self.mob.get_xp())
            return ActionResult(
                Result.WIN,
                f"You killed the {self.mob.get_name()}! You dealt {player_damage} damage to the {self.mob.get_name()}.",
            )


class PVP_Encounter:
    # Constructor
    def __init__(self, player: Player, opponent: Player):
        self.player = player
        self.opponent = opponent

    # Methods
    def do_player_attack(self):
        damage = self.player.do_attack()
        return self.opponent.take_damage(damage), damage

    def do_opponent_attack(self):
        damage = self.opponent.do_attack()
        return self.player.take_damage(damage), damage

    def battle(self):
        opponent_alive, player_damage = self.do_player_attack()
        if opponent_alive:
            player_alive, opponent_damage = self.do_opponent_attack()
            if not player_alive:
                return ActionResult(
                    Result.LOSE,
                    f"You died! You dealt {player_damage} damage to {self.opponent.get_name()}, but {self.opponent.get_name()} dealt {opponent_damage} damage to you.",
                )
            else:
                return ActionResult(
                    Result.CONTINUE,
                    f"You dealt {player_damage} damage to {self.opponent.get_name()}, but {self.opponent.get_name()} dealt {opponent_damage} damage to you.",
                )
        else:
            self.player.add_xp(self.opponent.get_level() * 5)
            return ActionResult(
                Result.WIN,
                f"You killed {self.opponent.get_name()}! You dealt {player_damage} damage to {self.opponent.get_name()}.",
            )
